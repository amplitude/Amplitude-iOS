name: Release

# on: 
#   workflow_dispatch:
#     inputs:
#       dryRun:
#         description: 'Do a dry run to preview instead of a real release'     
#         required: true
#         default: 'true'

on: push # @TODO Change to workflow dispatch

jobs:
  authorize: 
    name: Authorize
    runs-on: ubuntu-18.04
    steps:
      - name: ${{ github.actor }} permission check to do a release
        uses: octokit/request-action@v2.0.0
        with:
          route: GET /repos/:repository/collaborators/${{ github.actor }}
          repository: ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Release
    runs-on: ubuntu-18.04
    needs: [authorize]
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Setup Ruby
        uses: actions/setup-ruby@v1
        with:
          ruby-version: "2.6"

      - name: Setup Cocoapods
        run: |
          gem install cocoapods
          pod install

      - name: Validate Pod
        run: |
          pod lib lint

      # - name: Release --dry-run  # Uses release.config.js
      #   if: ${{ github.event.inputs.dryRun == 'true'}}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: ${{ secrets.AWS_REGION }}
      #     S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
      #   run: npx semantic-release --dry-run

      # - name: Release # Uses release.config.js
      #   if: ${{ github.event.inputs.dryRun == 'false'}}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: ${{ secrets.AWS_REGION }}
      #     S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
      #   run: npx semantic-release
